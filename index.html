<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Moldes para Costura v3.1</title>
    <style>
        :root {
            --primary-color: #2c6e49; /* Verde escuro */
            --secondary-color: #4c956c; /* Verde médio */
            --text-color: #333;
            --border-color: #ddd;
            --page-bg: #ffffff;
            --piece-bg: rgba(76, 149, 108, 0.1);
            --piece-border: #4c956c;
        }

        /* --- ESTILOS GERAIS E RESPONSIVIDADE --- */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            color: var(--text-color);
            margin: 0;
            padding: 15px;
        }
        .container {
            display: flex;
            flex-direction: column; /* Mobile-first */
            gap: 20px;
            max-width: 1600px;
            margin: auto;
        }
        .controls {
            background: var(--page-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        h1 { font-size: 1.6em; }
        h2 { font-size: 1.3em; }

        @media (min-width: 992px) {
            .container {
                flex-direction: row;
                align-items: flex-start;
            }
            .controls {
                flex: 0 0 450px;
            }
            .preview-area {
                flex: 1;
            }
        }

        /* --- ESTILOS DOS CONTROLES --- */
        #bulk-input {
            width: 100%;
            height: 280px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        button:hover {
            background-color: var(--primary-color);
        }
        .print-button {
            background-color: var(--primary-color);
        }
        .print-button:hover {
            background-color: #1e4c32;
        }

        /* --- ESTILOS DA VISUALIZAÇÃO --- */
        #canvas-container {
            background: #e9e9e9;
            padding: 20px;
            border-radius: 8px;
        }
        .page {
            background: var(--page-bg);
            width: 21cm;
            height: 29.7cm;
            position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin: 0 auto 20px auto;
            overflow: hidden;
            page-break-after: always;
        }
        .page-footer {
            position: absolute;
            bottom: 1cm;
            left: 1cm;
            right: 1cm;
            text-align: center;
            font-size: 10px;
            color: #aaa;
        }

        /* --- ESTILOS SVG --- */
        .piece-svg {
            position: absolute;
            overflow: visible;
        }
        .piece-shape {
            fill: var(--piece-bg);
            stroke: var(--piece-border);
            stroke-width: 1;
        }
        .helper-line {
            stroke: var(--piece-border);
            stroke-width: 0.5;
            stroke-dasharray: 3 2;
            opacity: 0.8;
            fill: none;
        }
        .piece-text {
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            fill: var(--primary-color);
            text-anchor: middle;
            pointer-events: none;
        }
        .piece-text-name {
            font-weight: bold;
            font-size: 14px;
        }
        .join-line {
            stroke: #d9534f;
            stroke-width: 1.5;
            stroke-dasharray: 5 3;
        }
        .join-text {
            font-size: 11px;
            fill: #d9534f;
            font-weight: bold;
            text-anchor: middle;
        }

        @media print {
            body { background-color: #fff; padding: 0; margin: 0; }
            .controls, .preview-area h1, .preview-area h2 { display: none; }
            .container { display: block; }
            #canvas-container { padding: 0; background: none; }
            .page { box-shadow: none; margin: 0; border-radius: 0; }
        }
    </style>
</head>
<body>

    <div class="container">
        <aside class="controls">
            <h1>Gerador de Moldes 3.1</h1>
            <label for="bulk-input">Insira as medidas (Nome, Largura x Altura, raio: [valor] [cantos], Qtde):</label>
            <textarea id="bulk-input">Corpo Atrás, 26x15, raio: 3 (todos), 1x Tecido 3x Forro
Corpo Frente (Baixo), 26x13, raio: 3 (inferiores), 1x Tecido 1x Forro
Corpo Frente (Cima), 26x9, raio: 3 (superiores), 1x Tecido 1x Forro
Fundo, 42x14, raio: 0, 1x Tecido 1x Forro
Faixa Zíper, 42x7, raio: 0, 2x Tecido 2x Forro
Faixa Vivo, 82x4, raio: 0, 2x Tecido
EVA Estrutura 1, 22x11, raio: 3 (todos), 1x EVA
EVA Estrutura 2, 38x10, raio: 0, 1x EVA
EVA Estrutura 3, 38x3, raio: 0, 2x EVA
Bolso Tela 1, 26x12, raio: 0, 1x Tela
Bolso Tela 2, 26x3, raio: 0, 1x Tela
Bolso Tela 3, 26x12, raio: 0, 1x Tela</textarea>
            <button onclick="generateLayout()">Gerar Moldes</button>
            <button onclick="window.print()" class="print-button">Salvar como PDF / Imprimir</button>
        </aside>

        <main class="preview-area">
            <h1>Visualização para Impressão</h1>
            <div id="canvas-container"></div>
        </main>
    </div>

    <script>
        const PX_PER_CM = 37.795;
        const PAGE_WIDTH_CM = 21;
        const PAGE_HEIGHT_CM = 29.7;
        const MARGIN_CM = 1;
        const GAP_CM = 0.5;

        const AVAILABLE_WIDTH_CM = PAGE_WIDTH_CM - (MARGIN_CM * 2);
        const AVAILABLE_HEIGHT_CM = PAGE_HEIGHT_CM - (MARGIN_CM * 2);

        function parseBulkInput() {
            const input = document.getElementById('bulk-input').value;
            return input.split('\n').filter(line => line.trim() !== '').map(line => {
                const parts = line.split(',').map(p => p.trim());
                const [name, dims, radiusStr, qty] = parts;
                const [w, h] = dims.toLowerCase().split('x').map(Number);
                
                let r = 0, corners = 'none';
                if (radiusStr && radiusStr.toLowerCase().includes('raio:')) {
                    const match = radiusStr.match(/raio:\s*([\d.]+)\s*\((.+)\)/i);
                    if (match) {
                        r = Number(match[1]);
                        corners = match[2].toLowerCase();
                    }
                }
                return { name, w, h, r, corners, qty, area: w * h };
            }).filter(p => p && p.w > 0 && p.h > 0);
        }

        function createNewPage(pageNumber) {
            const page = document.createElement('div');
            page.className = 'page';
            page.innerHTML = `<div class="page-footer">Página ${pageNumber} - Gerado por Manus AI</div>`;
            return page;
        }

        function generateLayout() {
            const pieces = parseBulkInput().sort((a, b) => b.area - a.area);
            const container = document.getElementById('canvas-container');
            container.innerHTML = '';

            let pages = [];
            let packer = new Packer();

            for (const piece of pieces) {
                if (piece.w > AVAILABLE_WIDTH_CM || piece.h > AVAILABLE_WIDTH_CM) {
                    splitAndPlacePiece(piece, pages, container);
                    continue;
                }

                let fit = packer.fit(piece);
                if (!fit) {
                    packer.newPage();
                    pages.push(createNewPage(pages.length + 1));
                    container.appendChild(pages[pages.length - 1]);
                    fit = packer.fit(piece);
                }
                
                if (fit) {
                    drawPiece(pages[pages.length - 1], piece, fit);
                }
            }
        }

        class Packer {
            constructor() {
                this.newPage();
            }

            newPage() {
                this.nodes = [{ x: MARGIN_CM, y: MARGIN_CM, w: AVAILABLE_WIDTH_CM, h: AVAILABLE_HEIGHT_CM }];
            }

            fit(piece) {
                let bestNode = null;
                let bestFitW, bestFitH;

                // Tenta encaixar sem rotação
                for (let i = 0; i < this.nodes.length; i++) {
                    let node = this.nodes[i];
                    if (piece.w <= node.w && piece.h <= node.h) {
                        bestNode = node;
                        bestFitW = piece.w;
                        bestFitH = piece.h;
                        break;
                    }
                }

                // Tenta encaixar com rotação
                for (let i = 0; i < this.nodes.length; i++) {
                    let node = this.nodes[i];
                    if (piece.h <= node.w && piece.w <= node.h) {
                        if (!bestNode || (bestNode && node.y < bestNode.y)) {
                            bestNode = node;
                            bestFitW = piece.h;
                            bestFitH = piece.w;
                        }
                        break;
                    }
                }

                if (bestNode) {
                    const fit = {
                        x: bestNode.x,
                        y: bestNode.y,
                        w: bestFitW,
                        h: bestFitH,
                        rotated: bestFitW === piece.h
                    };
                    this.splitNode(bestNode, fit.w, fit.h);
                    return fit;
                }
                return null;
            }

            splitNode(node, w, h) {
                this.nodes.push({ x: node.x + w + GAP_CM, y: node.y, w: node.w - w - GAP_CM, h: h });
                this.nodes.push({ x: node.x, y: node.y + h + GAP_CM, w: node.w, h: node.h - h - GAP_CM });
                this.nodes = this.nodes.filter(n => n.w > 0 && n.h > 0);
                this.nodes.sort((a, b) => a.y - b.y || a.x - b.x);
            }
        }

        function drawPiece(page, pieceData, fit) {
            const { name, r, corners, qty } = pieceData;
            const { x: x_cm, y: y_cm, w: w_cm, h: h_cm, rotated } = fit;

            const w_px = w_cm * PX_PER_CM;
            const h_px = h_cm * PX_PER_CM;
            const r_px = r * PX_PER_CM;

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute('class', 'piece-svg');
            svg.setAttribute('width', w_px);
            svg.setAttribute('height', h_px);
            svg.style.left = `${x_cm * PX_PER_CM}px`;
            svg.style.top = `${y_cm * PX_PER_CM}px`;

            let tl = 0, tr = 0, br = 0, bl = 0;
            if (r > 0) {
                const c = rotated ? { todos: 'todos', superiores: 'inferiores', inferiores: 'superiores' }[corners] : corners;
                if (c.includes('todos')) { tl = tr = br = bl = r_px; }
                if (c.includes('superiores')) { tl = tr = r_px; }
                if (c.includes('inferiores')) { bl = br = r_px; }
            }

            const d = `M ${tl},0 L ${w_px - tr},0 A ${tr},${tr} 0 0 1 ${w_px},${tr} L ${w_px},${h_px - br} A ${br},${br} 0 0 1 ${w_px - br},${h_px} L ${bl},${h_px} A ${bl},${bl} 0 0 1 0,${h_px - bl} L 0,${tl} A ${tl},${tl} 0 0 1 ${tl},0 Z`;
            const path = `<path class="piece-shape" d="${d}" />`;
            
            let helperLines = '';
            if (tl > 0) helperLines += `<path class="helper-line" d="M0,${tl} L${tl},${tl} L${tl},0" />`;
            if (tr > 0) helperLines += `<path class="helper-line" d="M${w_px-tr},0 L${w_px-tr},${tr} L${w_px},${tr}" />`;
            if (br > 0) helperLines += `<path class="helper-line" d="M${w_px},${h_px-br} L${w_px-br},${h_px-br} L${w_px-br},${h_px}" />`;
            if (bl > 0) helperLines += `<path class="helper-line" d="M${bl},${h_px} L${bl},${h_px-bl} L0,${h_px-bl}" />`;

            const text = `<text class="piece-text" x="${w_px/2}" y="${h_px/2}" dominant-baseline="middle">
                            <tspan class="piece-text-name" x="${w_px/2}">${name}</tspan>
                            <tspan x="${w_px/2}" dy="1.4em">${pieceData.w.toFixed(1)}cm x ${pieceData.h.toFixed(1)}cm</tspan>
                            <tspan x="${w_px/2}" dy="1.2em">${qty}</tspan>
                          </text>`;
            
            svg.innerHTML = path + helperLines + text;
            page.appendChild(svg);
        }
        
        function splitAndPlacePiece(piece, pages, container) {
            let remainingWidth = piece.w;
            let part = 1;
            while (remainingWidth > 0) {
                if (pages.length === 0) {
                    pages.push(createNewPage(1));
                    container.appendChild(pages[0]);
                }
                const newPage = createNewPage(pages.length + 1);
                pages.push(newPage);
                container.appendChild(newPage);

                const widthForThisPart = Math.min(remainingWidth, AVAILABLE_WIDTH_CM);
                const w_px = widthForThisPart * PX_PER_CM;
                const h_px = piece.h * PX_PER_CM;

                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute('class', 'piece-svg');
                svg.setAttribute('width', w_px);
                svg.setAttribute('height', h_px);
                svg.style.left = `${MARGIN_CM * PX_PER_CM}px`;
                svg.style.top = `${MARGIN_CM * PX_PER_CM}px`;

                let path = `<path class="piece-shape" d="M0,0 H${w_px} V${h_px} H0 Z" />`;
                let joinLines = '';
                if (part > 1) {
                    joinLines += `<line class="join-line" x1="1" y1="0" x2="1" y2="${h_px}" /><text class="join-text" x="20" y="${h_px/2}" transform="rotate(-90, 20, ${h_px/2})">Unir com Parte ${part-1}</text>`;
                }
                if (remainingWidth - widthForThisPart > 0) {
                    joinLines += `<line class="join-line" x1="${w_px-1}" y1="0" x2="${w_px-1}" y2="${h_px}" /><text class="join-text" x="${w_px-20}" y="${h_px/2}" transform="rotate(90, ${w_px-20}, ${h_px/2})">Unir com Parte ${part+1}</text>`;
                }
                const text = `<text class="piece-text" x="${w_px/2}" y="${h_px/2}" dominant-baseline="middle">
                                <tspan class="piece-text-name" x="${w_px/2}">${piece.name} (Parte ${part})</tspan>
                                <tspan x="${w_px/2}" dy="1.4em">${widthForThisPart.toFixed(1)}cm x ${piece.h.toFixed(1)}cm</tspan>
                                <tspan x="${w_px/2}" dy="1.2em">${piece.qty}</tspan>
                              </text>`;
                svg.innerHTML = path + joinLines + text;
                newPage.appendChild(svg);

                remainingWidth -= widthForThisPart;
                part++;
            }
        }

        window.onload = generateLayout;
    </script>
</body>
</html>
